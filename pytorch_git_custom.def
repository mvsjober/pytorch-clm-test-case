Bootstrap: library
From: centos:7.7

%labels
  Author Mats Sj√∂berg <mats.sjoberg@csc.fi>

%files
  libcudnn8-*8.1.0*.x86_64.rpm /opt/rpms/

%post
  # Upgrade packages to most recent versions
  yum -y upgrade

  # Enable EPEL (required by NVIDIA packages)
  yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

  # Install newer gcc and Python 3.8
  yum -y install centos-release-scl
  yum -y install devtoolset-9
  yum -y install rh-python38
  yum -y install rh-python38-python-devel
  yum -y install rh-git218
  source /opt/rh/devtoolset-9/enable
  source /opt/rh/rh-python38/enable
  source /opt/rh/rh-git218/enable

  # Install additional stuff
  yum -y install wget cmake cmake3 lbzip2 libsndfile less ncurses-devel

  # Install Mellanox stuff and OpenMPI
  wget https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox
  rpm --import RPM-GPG-KEY-Mellanox
  rm RPM-GPG-KEY-Mellanox

  cd /etc/yum.repos.d/
  # MOFED 5.0
  wget https://linux.mellanox.com/public/repo/mlnx_ofed/5.0-1.0.0.0/rhel7.8/mellanox_mlnx_ofed.repo
  yum -y install mlnx-ofed-all

  # Install CUDA
  cd /etc/yum.repos.d/
  wget https://developer.download.nvidia.com/compute/cuda/repos/rhel7/x86_64/cuda-rhel7.repo
  yum -y install nvidia-driver-latest-dkms cuda-11-3
  yum -y install cuda-drivers

  # Install CUDNN
  # Has to be manually downloaded from here: https://developer.nvidia.com/cudnn
  rpm -i /opt/rpms/libcudnn8*.rpm
  rm /opt/rpms/libcudnn8*.rpm

  # Install NCCL
  yum -y install libnccl-2.10.3-1+cuda11.4 libnccl-devel-2.10.3-1+cuda11.4 libnccl-static-2.10.3-1+cuda11.4

  set -e
  pip install setuptools==58.4.0
  pip install Cython astunparse numpy ninja pyyaml mkl mkl-include cffi typing_extensions future six requests dataclasses datasets
  pip install torchvision==0.10.1+cu111 torchaudio==0.9.1 torchtext==0.10.1 \
        -f https://download.pytorch.org/whl/torch_stable.html \

  export LD_LIBRARY_PATH=/opt/rh/rh-python38/root/usr/local/lib:$LD_LIBRARY_PATH

  export OMPI_DIR=$(ls -1d /usr/mpi/gcc/openmpi-4.0.* | head -n1)
  export PATH=$OMPI_DIR/bin:$PATH
  export LD_LIBRARY_PATH=$OMPI_DIR/lib64:$LD_LIBRARY_PATH
  export PATH=/usr/local/cuda/bin:$PATH

  cd /opt
  git clone https://github.com/pytorch/pytorch
  cd pytorch

  git checkout 3957ed4   # first commit with fast multi-node
  #git checkout 38ac9e6  # first commit with regression

  git submodule update --init --recursive

  export USE_SYSTEM_NCCL=1
  python setup.py install
  cd /opt
  rm -rf /opt/pytorch

  yum clean all

%environment
  export SLURM_MPI_TYPE=pmix_v2
  export PMIX_MCA_gds=hash

  export OMPI_DIR=$(ls -1d /usr/mpi/gcc/openmpi-4.0.* | head -n1)
  export PATH=/usr/local/cuda/bin:$OMPI_DIR/bin:$PATH
  export LD_LIBRARY_PATH=/usr/local/cuda/lib64/:$OMPI_DIR/lib64:/opt/rh/rh-python38/root/usr/local/lib:$LD_LIBRARY_PATH

  export CPPFLAGS=-I/opt/rh/rh-python38/root/usr/include/python3.8
  export LDFLAGS=-L/opt/rh/rh-python38/root/usr/lib64

  source /opt/rh/devtoolset-9/enable
  source /opt/rh/rh-python38/enable
  source /opt/rh/rh-git218/enable
